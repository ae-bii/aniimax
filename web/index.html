<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aniimax - Aniimo Production Optimizer</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <header>
        <h1>aniimax</h1>
        <div class="header-buttons">
            <button class="toggle-button" onclick="showMath()" id="mathToggle">math</button>
            <button class="toggle-button" onclick="showHelp()" id="helpToggle">help</button>
            <button class="toggle-button" onclick="toggleTheme()" id="themeToggle">light</button>
        </div>
    </header>
    <p class="subtitle">aniimo homeland production optimizer</p>
    <p class="disclaimer">Note: This project is a work in progress. Not all in-game items are included yet, and production times are assumed to match the values displayed in-game.</p>

    <div class="container">

        <main>
            <section class="config-section">
                <h2>Configuration</h2>
                
                <div class="config-group">
                    <div class="input-row">
                        <div class="input-field">
                            <label for="target">Target Amount</label>
                            <input type="number" id="target" value="1000" min="1">
                        </div>
                        <div class="input-field">
                            <label for="currency">Currency</label>
                            <select id="currency">
                                <option value="coins" selected>Coins</option>
                                <option value="coupons">Coupons</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-field">
                            <label for="energy-cost">Energy Cost/min</label>
                            <input type="number" id="energy-cost" value="0" min="0" step="0.1">
                        </div>
                        <div class="input-field checkbox-field">
                            <label>
                                <input type="checkbox" id="energy-self-sufficient">
                                Energy Self-Sufficient
                            </label>
                            <p class="hint small">Produce items to consume for energy instead of buying</p>
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-field checkbox-field">
                            <label>
                                <input type="checkbox" id="parallel-production">
                                Cross-Facility Parallel Production
                            </label>
                            <p class="hint small">Run multiple facility types simultaneously (ignored when energy self-sufficient is enabled)</p>
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-field checkbox-field">
                            <label>
                                <input type="checkbox" id="exclude-wheat">
                                Exclude Wheat
                            </label>
                            <p class="hint small">Exclude wheat and wheat byproducts (wheatmeal, super_wheatmeal) due to an in-game bug with wheat production</p>
                        </div>
                    </div>
                </div>

                <h3>Facilities</h3>
                <p class="hint">Set the count and level for each facility you have.</p>
                
                <div class="facilities-grid">
                    <div class="facility-card">
                        <h4>Farmland <span class="info-icon" data-tooltip="Lv.1: wheat, potatoes&#10;Lv.2: sugarcane, rice&#10;Lv.3: cotton, strawberry, soybean&#10;Lv.4: lavender, agave, rose (requires fertilizer)&#10;Lv.5: grape, ginseng, pumpkin (requires fertilizer)">?</span></h4>
                        <div class="facility-inputs">
                            <div class="input-field">
                                <label for="farmland-count">Count</label>
                                <input type="number" id="farmland-count" value="1" min="0" max="20">
                            </div>
                            <div class="input-field">
                                <label for="farmland-level">Level</label>
                                <input type="number" id="farmland-level" value="1" min="1" max="10">
                            </div>
                        </div>
                    </div>

                    <div class="facility-card">
                        <h4>Woodland <span class="info-icon" data-tooltip="Lv.1: chestnut, willow&#10;Lv.2: palm, bamboo, rubber&#10;Lv.3: lemon, coconut, maple syrup (requires fertilizer)&#10;Lv.4: walnut, pine (requires fertilizer)">?</span></h4>
                        <div class="facility-inputs">
                            <div class="input-field">
                                <label for="woodland-count">Count</label>
                                <input type="number" id="woodland-count" value="1" min="0" max="20">
                            </div>
                            <div class="input-field">
                                <label for="woodland-level">Level</label>
                                <input type="number" id="woodland-level" value="1" min="1" max="10">
                            </div>
                        </div>
                    </div>

                    <div class="facility-card">
                        <h4>Mineral Pile <span class="info-icon" data-tooltip="Lv.1: rock (coupons)&#10;Lv.2: copper (coupons)&#10;Lv.3: iron (coupons)&#10;Lv.4: quartz (coupons)&#10;Lv.5: gem (coins)">?</span></h4>
                        <div class="facility-inputs">
                            <div class="input-field">
                                <label for="mineral-pile-count">Count</label>
                                <input type="number" id="mineral-pile-count" value="1" min="0" max="20">
                            </div>
                            <div class="input-field">
                                <label for="mineral-pile-level">Level</label>
                                <input type="number" id="mineral-pile-level" value="1" min="1" max="10">
                            </div>
                        </div>
                    </div>

                    <div class="facility-card">
                        <h4>Carousel Mill <span class="info-icon" data-tooltip="Lv.1: wheatmeal (from wheat), rice processed (from rice)&#10;Lv.2: tofu (from soybean)">?</span></h4>
                        <div class="facility-inputs">
                            <div class="input-field">
                                <label for="carousel-mill-count">Count</label>
                                <input type="number" id="carousel-mill-count" value="1" min="0" max="20">
                            </div>
                            <div class="input-field">
                                <label for="carousel-mill-level">Level</label>
                                <input type="number" id="carousel-mill-level" value="1" min="1" max="10">
                            </div>
                        </div>
                    </div>

                    <div class="facility-card">
                        <h4>Jukebox Dryer <span class="info-icon" data-tooltip="Lv.1: potato chips (from potatoes)&#10;Lv.2: dried strawberry, dried bean curd (from tofu)&#10;Lv.3: dried lemon slices, dried flowers (lavender+rose), shredded coconut&#10;Lv.4: nuts (walnut+chestnut), herbs, dried grapes, caramel nut chips (nuts+maple syrup)">?</span></h4>
                        <div class="facility-inputs">
                            <div class="input-field">
                                <label for="jukebox-dryer-count">Count</label>
                                <input type="number" id="jukebox-dryer-count" value="1" min="0" max="20">
                            </div>
                            <div class="input-field">
                                <label for="jukebox-dryer-level">Level</label>
                                <input type="number" id="jukebox-dryer-level" value="1" min="1" max="10">
                            </div>
                        </div>
                    </div>

                    <div class="facility-card">
                        <h4>Crafting Table <span class="info-icon" data-tooltip="Lv.1: wood sculpture (from willow)&#10;Lv.2: bamboo ware (from bamboo)">?</span></h4>
                        <div class="facility-inputs">
                            <div class="input-field">
                                <label for="crafting-table-count">Count</label>
                                <input type="number" id="crafting-table-count" value="1" min="0" max="20">
                            </div>
                            <div class="input-field">
                                <label for="crafting-table-level">Level</label>
                                <input type="number" id="crafting-table-level" value="1" min="1" max="10">
                            </div>
                        </div>
                    </div>

                    <div class="facility-card">
                        <h4>Dance Pad Polisher <span class="info-icon" data-tooltip="Lv.1: SF basic exp gem (from sugarcane)&#10;Lv.2: SF medium exp gem (from strawberry)">?</span></h4>
                        <div class="facility-inputs">
                            <div class="input-field">
                                <label for="dance-pad-polisher-count">Count</label>
                                <input type="number" id="dance-pad-polisher-count" value="1" min="0" max="20">
                            </div>
                            <div class="input-field">
                                <label for="dance-pad-polisher-level">Level</label>
                                <input type="number" id="dance-pad-polisher-level" value="1" min="1" max="10">
                            </div>
                        </div>
                    </div>

                    <div class="facility-card">
                        <h4>Aniipod Maker <span class="info-icon" data-tooltip="Lv.1: SF aniipod (from rock)&#10;Lv.2: SF aniipod pro (from copper)">?</span></h4>
                        <div class="facility-inputs">
                            <div class="input-field">
                                <label for="aniipod-maker-count">Count</label>
                                <input type="number" id="aniipod-maker-count" value="1" min="0" max="20">
                            </div>
                            <div class="input-field">
                                <label for="aniipod-maker-level">Level</label>
                                <input type="number" id="aniipod-maker-level" value="1" min="1" max="10">
                            </div>
                        </div>
                    </div>

                    <div class="facility-card">
                        <h4>Nimbus Bed <span class="info-icon" data-tooltip="Required for Farmland Lv.4+ and Woodland Lv.3+ items&#10;Produces: fertilizer (30), wool (2), petals (8) per batch">?</span></h4>
                        <div class="facility-inputs">
                            <div class="input-field">
                                <label for="nimbus-bed-count">Count</label>
                                <input type="number" id="nimbus-bed-count" value="0" min="0" max="20">
                            </div>
                            <div class="input-field">
                                <label for="nimbus-bed-level">Level</label>
                                <input type="number" id="nimbus-bed-level" value="1" min="1" max="10">
                            </div>
                        </div>
                    </div>
                </div>

                <h3>Item Upgrade Modules</h3>
                <p class="hint">Set the level for each upgrade module you have unlocked (0 = not unlocked).</p>
                
                <div class="modules-grid">
                    <div class="module-card">
                        <h4>Ecological Module <span class="info-icon" data-tooltip="Lv.1: high-speed wheat (+5 yield)&#10;Lv.2: high-speed willow (+2 yield)&#10;Lv.3: high-speed bamboo (+4 yield)&#10;Lv.4: high-speed rubber (+3 yield)&#10;Lv.5: high-speed pine (+1 yield)">?</span></h4>
                        <div class="input-field">
                            <label for="ecological-module-level">Level</label>
                            <input type="number" id="ecological-module-level" value="0" min="0" max="10">
                        </div>
                    </div>

                    <div class="module-card">
                        <h4>Kitchen Module <span class="info-icon" data-tooltip="Lv.2: super wheatmeal (210 vs 150 sell)&#10;Lv.3: premium dried strawberry (546 vs 437 sell)&#10;Lv.4: high grade herbs (4463 vs 3570 sell)">?</span></h4>
                        <div class="input-field">
                            <label for="kitchen-module-level">Level</label>
                            <input type="number" id="kitchen-module-level" value="0" min="0" max="10">
                        </div>
                    </div>

                    <div class="module-card">
                        <h4>Mineral Detector <span class="info-icon" data-tooltip="Lv.1: high-speed rock (+2 yield)&#10;Lv.2: high-speed copper (+2 yield, faster)&#10;Lv.3: high-speed iron (+2 yield, faster)&#10;Lv.4: high-speed quartz (+1 yield, faster)&#10;Lv.5: high-speed gem (+1 yield, faster)">?</span></h4>
                        <div class="input-field">
                            <label for="mineral-detector-level">Level</label>
                            <input type="number" id="mineral-detector-level" value="0" min="0" max="10">
                        </div>
                    </div>

                    <div class="module-card">
                        <h4>Crafting Module <span class="info-icon" data-tooltip="Lv.1: advanced wood sculpture (431 vs 345 sell)">?</span></h4>
                        <div class="input-field">
                            <label for="crafting-module-level">Level</label>
                            <input type="number" id="crafting-module-level" value="0" min="0" max="10">
                        </div>
                    </div>
                </div>

                <button id="optimize-btn" class="optimize-btn">
                    <span class="btn-text">Calculate Optimal Path</span>
                    <span class="btn-loading" style="display: none;">Calculating...</span>
                </button>
            </section>

            <section class="results-section" id="results-section" style="display: none;">
                <h2>Results</h2>
                
                <div id="error-message" class="error-message" style="display: none;"></div>
                
                <div id="results-content">
                    <div class="result-summary">
                        <h3>Optimal Production Path</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <span class="summary-label">Total Profit</span>
                                <span class="summary-value" id="total-profit">-</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Total Time</span>
                                <span class="summary-value" id="total-time">-</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Total Energy</span>
                                <span class="summary-value" id="total-energy">-</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Items Produced</span>
                                <span class="summary-value" id="items-produced">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="production-steps">
                        <h3>Production Steps</h3>
                        <div id="steps-list" class="steps-list"></div>
                    </div>

                    <div class="all-options">
                        <h3>All Options Ranked</h3>
                        <p class="hint">Sorted by <span id="sort-criteria">time efficiency</span></p>
                        <div class="table-wrapper">
                            <table id="options-table">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Facility</th>
                                        <th>Profit/sec</th>
                                        <th>Profit/energy</th>
                                        <th>Time/unit</th>
                                    </tr>
                                </thead>
                                <tbody id="options-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>aniimax v<span id="version">-</span> | <a href="https://github.com/ae-bii/aniimax" target="_blank">github</a></p>
        </footer>
    </div>

    <!-- Math Modal -->
    <div id="mathModal" class="modal" onclick="closeMathOnBackdrop(event)">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2>How It Works</h2>
                <button class="close-button" onclick="closeMath()">&times;</button>
            </div>
            <div class="modal-body">
                <h3>Production Efficiency</h3>
                <p>For each item, we calculate the <strong>profit per second</strong> to find the most efficient production path.</p>
                
                <h4>Raw Materials</h4>
                <p>For raw materials (items produced directly from facilities like Farmland):</p>
                <div class="math-block">\[ \text{Profit/sec} = \frac{(\text{yield} \times \text{sell_price}) - \text{cost}}{t_{\text{effective}}} \]</div>
                <p>Where effective time accounts for parallel production with multiple facilities:</p>
                <div class="math-block">\[ t_{\text{effective}} = \frac{t_{\text{production}}}{n_{\text{facilities}}} \]</div>
                
                <h4>Processed Items</h4>
                <p>For processed items that require raw materials, production is limited by the <strong>bottleneck</strong>:</p>
                <div class="math-block">\[ \text{Gathering Rate} = \frac{n_{\text{gatherers}} \times \text{yield}}{t_{\text{gather}} \times \text{required_amount}} \]</div>
                <div class="math-block">\[ \text{Processing Rate} = \frac{n_{\text{processors}}}{t_{\text{process}}} \]</div>
                <div class="math-block">\[ \text{Effective Rate} = \min(\text{Gathering Rate}, \text{Processing Rate}) \]</div>
                
                <h3>Cross-Facility Parallel Production</h3>
                <p>When enabled, multiple independent production chains run simultaneously:</p>
                <div class="math-block">\[ \text{Total Profit/sec} = \sum_{i=1}^{k} \text{profit_rate}_i \]</div>
                <p>Chains are selected greedily by efficiency, skipping any that conflict with already-selected facilities.</p>
                
                <h3>Optimal Facility Allocation</h3>
                <p>When a recipe requires multiple raw materials from the <strong>same facility type</strong> (e.g., lavender + rose from Farmland), we optimize how to split facilities.</p>
                
                <h4>The Problem</h4>
                <p>Minimize the maximum completion time across all materials:</p>
                <div class="math-block">\[ \min \max_i \left( \left\lceil \frac{B_i}{f_i} \right\rceil \times t_i \right) \quad \text{s.t.} \quad \sum_i f_i = F \]</div>
                <p>Where:</p>
                <ul>
                    <li>\(B_i\) = batches needed for material \(i\)</li>
                    <li>\(f_i\) = facilities allocated to material \(i\)</li>
                    <li>\(t_i\) = production time for material \(i\)</li>
                    <li>\(F\) = total facilities available</li>
                </ul>
                
                <h4>The Algorithm</h4>
                <p>We use <strong>binary search on candidate completion times</strong>:</p>
                <ol>
                    <li><strong>Generate candidates:</strong> For each material, possible completion times are \(\lceil B_i / k \rceil \cdot t_i\) for \(k = 1, 2, \ldots\). Using the divisor counting trick, there are only \(O(\sqrt{B_i})\) distinct values.</li>
                    <li><strong>Binary search:</strong> For candidate time \(T\), check feasibility:
                        <ul>
                            <li>Max rounds for material \(i\): \(r_i = \lfloor T / t_i \rfloor\)</li>
                            <li>Min facilities needed: \(\lceil B_i / r_i \rceil\)</li>
                            <li>Feasible if \(\sum_i \lceil B_i / r_i \rceil \leq F\)</li>
                        </ul>
                    </li>
                    <li><strong>Allocate:</strong> Assign minimum facilities, then greedily distribute remaining.</li>
                </ol>
                
                <h4>Example</h4>
                <p>Producing dried_flowers (requires lavender + rose) with 20 Farmlands:</p>
                <table class="math-table">
                    <tr><th>Material</th><th>Batches</th><th>Time</th></tr>
                    <tr><td>lavender</td><td>666</td><td>5400s</td></tr>
                    <tr><td>rose</td><td>666</td><td>8100s</td></tr>
                </table>
                <p><strong>Naive split (10 each):</strong></p>
                <div class="math-block">\[ t = \max\left(\lceil 666/10 \rceil \times 5400, \lceil 666/10 \rceil \times 8100\right) = 542700s \]</div>
                <p><strong>Optimal split (8 lavender, 12 rose):</strong></p>
                <div class="math-block">\[ t = \max\left(\lceil 666/8 \rceil \times 5400, \lceil 666/12 \rceil \times 8100\right) = 453600s \]</div>
                <p>The optimal allocation saves ~25 hours by giving more facilities to the slower material.</p>
                
                <h3>Complexity</h3>
                <table class="math-table">
                    <tr><th>Operation</th><th>Complexity</th></tr>
                    <tr><td>Efficiency calculation</td><td>\(O(n \cdot m^2)\)</td></tr>
                    <tr><td>Parallel mode selection</td><td>\(O(n \log n + n \cdot f)\)</td></tr>
                    <tr><td>Facility allocation</td><td>\(O(M \cdot \sqrt{B} \cdot \log(M\sqrt{B}))\)</td></tr>
                </table>
                <p>Where \(n\) = items, \(m\) = chain depth, \(f\) = facilities per chain, \(M\) = materials in recipe, \(B\) = max batches.</p>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal" onclick="closeHelpOnBackdrop(event)">
        <div class="modal-content">
            <div class="modal-header">
                <h2>How to Use</h2>
                <button class="close-button" onclick="closeHelp()">&times;</button>
            </div>
            <div class="modal-body">
                <h3>1. Set Your Target</h3>
                <p>Enter the amount of currency (coins or coupons) you want to earn.</p>
                
                <h3>2. Configure Facilities</h3>
                <p>Set the count and level of each facility you have unlocked in Aniimo Homeland.</p>
                
                <h3>3. Set Upgrade Modules</h3>
                <p>Enter the level of each upgrade module you've unlocked (0 = not unlocked).</p>
                
                <h3>4. Calculate</h3>
                <p>Click "Calculate Optimal Path" to find the most efficient production strategy.</p>
                
                <h3>Understanding Results</h3>
                <ul>
                    <li><strong>Profit/sec</strong>: How much currency you earn per second</li>
                    <li><strong>Total time</strong>: How long to reach your target</li>
                    <li><strong>Startup time</strong>: Time before first batch completes</li>
                    <li><strong>Production steps</strong>: What to produce and where</li>
                </ul>
                
                <h3>Options</h3>
                <ul>
                    <li><strong>Energy Cost</strong>: If you buy energy, enter cost per minute to factor it into calculations</li>
                    <li><strong>Energy Self-Sufficient</strong>: Produce items to consume for energy instead of buying</li>
                    <li><strong>Parallel Production</strong>: Run multiple facility types at once for higher throughput</li>
                </ul>
                
                <h3>Optimal Facility Allocation</h3>
                <p>When producing items that need multiple raw materials from the same facility (e.g., lavender + rose for dried_flowers), aniimax calculates the optimal way to split your facilities to minimize production time.</p>
            </div>
        </div>
    </div>

    <script>
        window.toggleTheme = function() {
            const body = document.body;
            const button = document.getElementById('themeToggle');
            body.classList.toggle('light');
            if (body.classList.contains('light')) {
                button.textContent = 'dark';
            } else {
                button.textContent = 'light';
            }
        }
        
        window.showHelp = function() {
            document.getElementById('helpModal').classList.add('show');
        }
        
        window.closeHelp = function() {
            document.getElementById('helpModal').classList.remove('show');
        }
        
        window.closeHelpOnBackdrop = function(event) {
            if (event.target.id === 'helpModal') {
                closeHelp();
            }
        }
        
        window.showMath = function() {
            document.getElementById('mathModal').classList.add('show');
            // Trigger MathJax to render
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }
        
        window.closeMath = function() {
            document.getElementById('mathModal').classList.remove('show');
        }
        
        window.closeMathOnBackdrop = function(event) {
            if (event.target.id === 'mathModal') {
                closeMath();
            }
        }
        
        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeHelp();
                closeMath();
            }
        });
    </script>
    <script type="module" src="app.js"></script>
</body>
</html>
